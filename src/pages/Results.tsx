import React from 'react';
import { useStore } from '../store/useStore';
import { useLangStore } from '../store/useLangStore';
import { Layout } from '../components/Layout';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } from 'recharts';
import jsPDF from 'jspdf';
import { Download, RefreshCcw } from 'lucide-react';
import { FigLabel } from '../components/Decorations';

const salaryRates: Record<string, number> = {
  'TVöD EG 5': 45, // EUR/hr estimated employer cost
  'TVöD EG 6': 48,
  'TVöD EG 7': 52,
  'TVöD EG 8': 56,
};

export const Results: React.FC = () => {
  const { 
    municipalityName, 
    useCase, 
    stepDurations, 
    digitalSteps, 
    salaryGroup, 
    monthlyVolume,
    reset 
  } = useStore();
  const { t } = useLangStore();

  // Calculations
  const hourlyRate = salaryRates[salaryGroup] || 50;

  const totalAnalogTimeMin = stepDurations.reduce((acc, s) => acc + s.actual, 0);
  
  const totalDigitalTimeMin = digitalSteps.reduce((acc, s) => {
    const analogDuration = stepDurations.find(ad => ad.id === s.id)?.actual || 0;
    const digRate = s.digitalizationPercent / 100;
    return acc + (s.digitalDuration * digRate) + (analogDuration * (1 - digRate));
  }, 0);

  const timeSavedMin = totalAnalogTimeMin - totalDigitalTimeMin;
  
  const costAnalog = (totalAnalogTimeMin / 60) * hourlyRate;
  const costDigital = (totalDigitalTimeMin / 60) * hourlyRate;
  const costSaved = costAnalog - costDigital;

  const monthlySavings = costSaved * monthlyVolume;
  const yearlySavings = monthlySavings * 12;
  const fiveYearSavings = yearlySavings * 5;

  const hoursFreedPerMonth = (timeSavedMin * monthlyVolume) / 60;
  const fteFreed = hoursFreedPerMonth / 160; // Approx 160h/month work

  // Data for Charts
  const comparisonData = [
    { name: 'Analog', Time: totalAnalogTimeMin, Cost: costAnalog },
    { name: 'Digital (eWA)', Time: totalDigitalTimeMin, Cost: costDigital },
  ];

  const projectionData = Array.from({ length: 5 }, (_, i) => ({
    year: `Year ${i + 1}`,
    savings: yearlySavings * (i + 1),
  }));

  const handleDownloadPdf = () => {
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text(`DiviData Report: ${municipalityName}`, 20, 20);
    
    doc.setFontSize(12);
    doc.text(`Use Case: ${useCase}`, 20, 30);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 36);
    
    doc.setFontSize(16);
    doc.text('Key Findings', 20, 50);
    
    doc.setFontSize(12);
    doc.text(`${t.timeSavedCase}: ${timeSavedMin.toFixed(1)} min`, 20, 60);
    doc.text(`${t.costPerCase}: ${costSaved.toFixed(2)} EUR`, 20, 66);
    doc.text(`${t.costSavingsYear}: ${yearlySavings.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' })}`, 20, 72);
    
    doc.text(`${t.hoursFreedMonth}: ${hoursFreedPerMonth.toFixed(1)} hours`, 20, 90);
    doc.text(`${t.fte}: ${fteFreed.toFixed(2)} FTE`, 20, 96);
    
    doc.text('This report was generated by DiviData.', 20, 280);
    
    doc.save('dividata-report.pdf');
  };

  return (
    <Layout>
      <div className="space-y-8 animate-fade-in pb-12">
        <div className="flex justify-between items-center mb-8">
          <div>
            <FigLabel>{t.figure40}</FigLabel>
            <h1 className="text-4xl font-light text-hb-ink mb-2">{t.roiTitle}</h1>
            <p className="text-hb-gray font-light">{t.projectedImpact} {municipalityName}</p>
          </div>
          <div className="flex space-x-4">
             <button
              onClick={() => {
                if (confirm(t.reset + '?')) {
                  reset();
                  window.location.href = '/';
                }
              }}
              className="hb-btn-secondary text-hb-gray hover:text-hb-ink px-4 py-2 transition-colors flex items-center border-transparent hover:border-transparent"
            >
              <RefreshCcw size={18} className="mr-2" />
              {t.reset}
            </button>
            <button
              onClick={handleDownloadPdf}
              className="hb-btn-primary flex items-center shadow-lg shadow-black/5"
            >
              <Download size={20} className="mr-2" />
              {t.downloadReport}
            </button>
          </div>
        </div>

        {/* Summary Cards */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div className="hb-card border-l-2 border-l-hb-ink">
            <h3 className="text-hb-gray text-xs font-medium uppercase tracking-wider">{t.costSavingsYear}</h3>
            <p className="text-3xl font-display text-hb-ink mt-3">
              {yearlySavings.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' })}
            </p>
            <p className="text-xs text-hb-gray/60 mt-2 font-mono">
              + {fiveYearSavings.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' })} ({t.over5Years})
            </p>
          </div>
          
          <div className="hb-card border-l border-l-hb-line">
            <h3 className="text-hb-gray text-xs font-medium uppercase tracking-wider">{t.timeSavedCase}</h3>
            <p className="text-3xl font-display text-hb-ink mt-3">
              {timeSavedMin.toFixed(1)} min
            </p>
            <p className="text-xs text-hb-gray/60 mt-2 font-mono">
              {totalAnalogTimeMin.toFixed(0)}m ➝ {totalDigitalTimeMin.toFixed(0)}m
            </p>
          </div>

          <div className="hb-card border-l border-l-hb-line">
            <h3 className="text-hb-gray text-xs font-medium uppercase tracking-wider">{t.hoursFreedMonth}</h3>
            <p className="text-3xl font-display text-hb-ink mt-3">
              {hoursFreedPerMonth.toFixed(0)} h
            </p>
            <p className="text-xs text-hb-gray/60 mt-2 font-mono">
              ~ {fteFreed.toFixed(2)} {t.fte}
            </p>
          </div>

           <div className="hb-card border-l border-l-hb-line">
            <h3 className="text-hb-gray text-xs font-medium uppercase tracking-wider">{t.volume}</h3>
            <p className="text-3xl font-display text-hb-ink mt-3">
              {monthlyVolume}
            </p>
            <p className="text-xs text-hb-gray/60 mt-2 font-mono">
              {t.casesMonth}
            </p>
          </div>
        </div>

        {/* Charts Row 1 */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div className="hb-card">
            <FigLabel className="absolute top-6 left-8">{t.figure41}</FigLabel>
            <h3 className="text-lg font-light mb-8 mt-4">{t.processTimeComparison}</h3>
            <div className="h-80">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={comparisonData}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E0E0E0" />
                  <XAxis dataKey="name" stroke="#666666" tick={{fill: '#666666', fontSize: 12}} tickLine={false} axisLine={false} />
                  <YAxis stroke="#666666" tick={{fill: '#666666', fontSize: 12}} tickLine={false} axisLine={false} />
                  <Tooltip 
                    contentStyle={{ backgroundColor: '#FFFFFF', borderColor: '#E0E0E0', color: '#111111', fontFamily: 'Inter', fontSize: '12px' }}
                    itemStyle={{ color: '#111111' }}
                    cursor={{fill: '#F7F7F7'}}
                  />
                  <Legend wrapperStyle={{ paddingTop: '20px', fontSize: '12px', color: '#666666' }} />
                  <Bar dataKey="Time" fill="#111111" name={t.minPerCase} barSize={40} />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          <div className="hb-card">
            <FigLabel className="absolute top-6 left-8">{t.figure42}</FigLabel>
            <h3 className="text-lg font-light mb-8 mt-4">{t.processCostComparison}</h3>
            <div className="h-80">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={comparisonData}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E0E0E0" />
                  <XAxis dataKey="name" stroke="#666666" tick={{fill: '#666666', fontSize: 12}} tickLine={false} axisLine={false} />
                  <YAxis stroke="#666666" tick={{fill: '#666666', fontSize: 12}} tickLine={false} axisLine={false} />
                  <Tooltip 
                    formatter={(value) => Number(value).toFixed(2) + ' €'} 
                    contentStyle={{ backgroundColor: '#FFFFFF', borderColor: '#E0E0E0', color: '#111111', fontFamily: 'Inter', fontSize: '12px' }}
                    itemStyle={{ color: '#111111' }}
                    cursor={{fill: '#F7F7F7'}}
                  />
                  <Legend wrapperStyle={{ paddingTop: '20px', fontSize: '12px', color: '#666666' }} />
                  <Bar dataKey="Cost" fill="#666666" name={t.costPerCase} barSize={40} />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>
        </div>

        {/* Charts Row 2 */}
        <div className="hb-card">
          <FigLabel className="absolute top-6 left-8">{t.figure43}</FigLabel>
          <h3 className="text-lg font-light mb-8 mt-4">{t.cumulativeSavings}</h3>
          <div className="h-80">
            <ResponsiveContainer width="100%" height="100%">
              <LineChart data={projectionData}>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E0E0E0" />
                <XAxis dataKey="year" stroke="#666666" tick={{fill: '#666666', fontSize: 12}} tickLine={false} axisLine={false} />
                <YAxis stroke="#666666" tick={{fill: '#666666', fontSize: 12}} tickLine={false} axisLine={false} />
                <Tooltip 
                  formatter={(value) => Number(value).toLocaleString('de-DE', { style: 'currency', currency: 'EUR' })} 
                  contentStyle={{ backgroundColor: '#FFFFFF', borderColor: '#E0E0E0', color: '#111111', fontFamily: 'Inter', fontSize: '12px' }}
                  itemStyle={{ color: '#111111' }}
                />
                <Legend wrapperStyle={{ paddingTop: '20px', fontSize: '12px', color: '#666666' }} />
                <Line 
                  type="monotone" 
                  dataKey="savings" 
                  stroke="#111111" 
                  strokeWidth={2} 
                  name={t.cumSavings}
                  dot={{ r: 4, fill: "#FFFFFF", stroke: "#111111", strokeWidth: 2 }}
                  activeDot={{ r: 6, fill: "#111111" }}
                />
              </LineChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>
    </Layout>
  );
};
